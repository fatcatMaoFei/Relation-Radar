# Relation Radar 开发协作规范

本仓库目前为私有仓库，面向少量协作者。目标是：**小步快跑、可回溯、易 review**。

本文约定的规则适用于所有分支和 PR。

---

## 1. 分支与 PR 流程

### 1.1 分支策略

- 主分支：`main`  
  - 始终保持可运行（至少不崩溃）。  
  - 只通过 PR 合并，不在 `main` 上直接提交。

- 功能分支命名约定：
  - 对应 `dev_plan.md` 的 PR 编号：  
    - `feature/pr-0.1-02-db-schema`  
    - `feature/pr-0.2-06-notebook-ui`  
  - 临时试验分支可以用：`exp/...`，但不直接合并到 `main`。

### 1.2 PR 粒度

- 每个 PR 尽量只做一件清晰的事：  
  - 对应 `dev_plan.md` 里的一条，或其中的一个子目标。  
- 控制改动量：  
  - 优先小 PR（建议 < 400 行有效代码改动）。  
  - 大规模重构（命名、格式化）要单独一个 PR，避免和逻辑变更混在一起。

### 1.3 PR 流程

1. 从 `main` 拉出新分支：  
   - `git checkout main`  
   - `git pull`  
   - `git checkout -b feature/pr-0.1-02-db-schema`
2. 在该分支完成对应改动和自测。
3. 提交前执行「基础检查」（见第 4 节）。
4. 提交并推送分支，发起 PR：  
   - 标题包含 `PR-0.x-YY` 编号和简短说明。  
   - 描述中要写明：改动范围、关联的 `dev_plan.md` 条目、验证方式。
5. 至少 1 人 review 通过后再 squash / rebase 合并进 `main`。

---

## 2. 代码与结构约定

### 2.1 语言与版本

- Python 3.10+（如需变更版本需在 PR 中说明并更新 README/配置）。

### 2.2 目录约定

- 产品文档：`prd.md`  
- 开发计划：`dev_plan.md`  
- 配置与 prompts：`config/`  
- 后端核心逻辑：`backend/`  
- MCP server：`mcp_server/`  
- 前端：`frontend/`  
- 脚本工具：`scripts/`

新增文件时优先遵循现有结构，不随意引入新的顶层目录。

### 2.3 代码风格（Python）

当前阶段不强制具体格式化工具，但有以下约定：

- 使用 4 空格缩进。  
- 变量/函数名使用小写 + 下划线：`snake_case`。  
- 类名使用 `PascalCase`。  
- 避免过长函数（> 80 行）和过长文件（> 600 行）；必要时拆模块。  
- 尽量写类型注解（特别是公共函数的入参/返回值）。

后续如引入 `black`/`ruff`/`isort` 等工具，会在 README 和本规范中补充要求。

---

## 3. 文档更新规则

- 如 PR 引入了对产品行为的明显变化（新增功能/接口、重要约束），**必须**考虑是否需要同步更新：
  - `prd.md`（产品层面的需求/行为变化）；  
  - `dev_plan.md`（开发计划的状态或拆分调整）；  
  - `README.md`（对外使用方式的变化）。
- 如果 PR 只改内部实现、不改变行为（例如重构、性能优化），可以不改 `prd.md`，但建议在 PR 描述中说明“不影响对外行为”。
- 不建议在同一个 PR 里同时做大量代码改动和大量文档重写，如确有需要，请在描述中写清楚原因。

---

## 4. 基础检查（Before PR）

在发起 PR 前，至少应完成以下本地检查（后续可迁移到 CI）：

1. **依赖安装**  
   - `pip install -r requirements.txt`（首次或依赖更新后）。

2. **语法检查**  
   - 在仓库根目录运行：  
     - `python -m compileall backend frontend mcp_server scripts`  
   - 目标：确保无语法错误、漏掉的括号等基础问题。

3. **基础运行/冒烟测试**（根据改动范围选择）
   - 如改动 CLI：至少运行一次相关命令（例如 `python -m frontend.cli.main --help` 或实际子命令）。  
   - 如改动 Web API：本地启动后简单调一两个接口。  
   - 如改动 DB/schema：跑一遍 `scripts/init_db.py`，确保 DB 能正常生成。

4. **测试（如果存在）**  
   - 当仓库引入测试后（如 `tests/`），在提交前应运行：  
     - `pytest` 或项目指定的测试命令。  
   - 若存在已知失败但与当前 PR 无关，应在 PR 描述中说明现状。

5. **自查清单（建议在 PR 描述中勾选）**
   - [ ] 改动范围清晰，尽量只做一件事。  
   - [ ] 关键路径代码已进行基本自测。  
   - [ ] 无明显 debug 打印、临时代码（如 `print`, `pdb` 等）。  
   - [ ] 如有必要，相关文档已更新（`prd.md` / `dev_plan.md` / `README.md`）。

---

## 5. Review 约定

- Review 时的关注点：
  - 是否遵守 PR 范围和结构规则。  
  - 是否破坏已有行为（如有，是否在描述中讲清楚）。  
  - 是否有明显可简化的地方（过度复杂逻辑、不必要的依赖）。  
  - 是否有明显安全/隐私风险（尤其是与数据输出、远端调用相关的改动）。

- 建议的 Review 方式：
  - 优先从整体设计看起（是否与 `prd.md`、`dev_plan.md` 一致）。  
  - 再按模块快速扫过（backend/core、rag、llm、frontend）。  
  - 对于不确定的问题，多用“提问式评论”，让作者补充背景。

---

## 6. 后续可能引入的工具（预告）

这些不是当前硬要求，但后续可以按需在独立 PR 中引入：

- 格式化：`black` 或 `ruff format`。  
- Lint：`ruff`。  
- 类型检查：`mypy`。  
- CI：GitHub Actions 做基础检查（安装依赖 + `python -m compileall` + 测试）。

当这些工具被引入时，会在本文件和 `README.md` 中更新对应规范。

